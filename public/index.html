<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Mural</title>
    <link href="style.css" type="text/css" rel="stylesheet">
</head>

<body>
    <h1>Mural</h1>
    <form method="POST" action="/images">
        <label for="what-is-the-image-src">What is the image's URL?</label>
        <input type="text" id="what-is-the-image-src" name="src" />
        <div>
            <span>What should the image's border color be?</span>
            <input type="radio" id="red" name="borderColor" value="rgba(255, 0, 0, 1)" checked>
            <label for="red">Red</label>
            <input type="radio" id="green" name="borderColor" value="rgba(0, 255, 0, 1)">
            <label for="green">Green</label>
            <input type="radio" id="blue" name="borderColor" value="rgba(0, 0, 255, 1)">
            <label for="blue">Blue</label>
        </div>
        <div>
            <input type="submit" />
        </div>
    </form>
    <div id="squares-div">
    </div>
    <form method="POST" action= "/reset">
        <input type="submit" name="reset" value="Reset" />
    </form>

    <script>
        fetch('/images')
        .then(response => response.json())
        .then(displayImagesInSquares);

        // .then(images => {
        //     buildGrid(images.length);

        //     images.forEach((image, index) => {
        //         let img = document.createElement('img');
        //         img.setAttribute('src', image.src);
        //         img.setAttribute('alt', 'user-selected image');
        //         let imageSquare = document.getElementById('square' + index);
        //         imageSquare.style.borderColor = image.borderColor;
        //         imageSquare.appendChild(img);
        //         eventListenersForSquares(image, imageSquare);
        //     });
        // });

        function displayImagesInSquares(images) {
            buildGrid(images.length);

            images.forEach((image, index) => {
                let img = document.createElement('img');
                img.setAttribute('src', image.src);
                img.setAttribute('alt', 'user-selected image');
                let imageSquare = document.getElementById('square' + index);
                imageSquare.style.borderColor = image.borderColor;
                imageSquare.appendChild(img);
                eventListenersForSquares(image, imageSquare);
            });
        }
        
        function buildGrid(numberOfSquares) {
            for (let i = 0; i < numberOfSquares; i++) {
                let square = document.createElement('div');
                square.classList.add('square');
                square.id = 'square' + i;
                document.getElementById('squares-div').appendChild(square);
            }
        }
        
        function eventListenersForSquares(image, imageSquare) {
            imageSquare.addEventListener('mouseover', () => {
                imageSquare.style.backgroundColor = image.borderColor.replace(/(rgba\(\d+, \d+, \d+,) 1\)/, '$1 0.5)');
            });

            imageSquare.addEventListener('mouseleave', () => {
                imageSquare.style.backgroundColor = 'white';
                let colorButtons = document.getElementsByClassName('colorButton');
                for (let button of colorButtons) {
                    button.remove();
                }
            });

            imageSquare.addEventListener('click', addColorButton);

            function addColorButton() {
                imageSquare.insertAdjacentHTML('afterbegin', `<button class="colorButton" onclick="changeColor(${image})">Click here to change border color</button>`);
            }
        }

        function changeColor(image) {
            let colors = [
                'rgba(255, 0, 0, 1)', 
                'rgba(0, 255, 0, 1)',
                'rgba(0, 0, 255, 1)'   
            ];
            let currentColorIndex = colors.indexOf(image.borderColor);
            let nextColor = colors[(currentColorIndex + 1) % colors.length];

            let params = new URLSearchParams();
            params.append('imageId', image['_id']);
            params.append('color', nextColor);

            console.log('params:', params);

            fetch('/color', {
                method: 'POST',
                body: params
            })
            .then(response => response.json())
            .then(displayImagesInSquares);
        }
        
    </script>




</body>

</html>